parameters:
  - name: api_inputs
    displayName: Inputs from API (json)
    type: string
  - name: config
    displayName: Inputs from user workflow (json)
    type: string


steps:
- bash: |
    ##VARIABLES
    CI=true
    echo "##vso[task.setvariable variable=CI;]$CI"

    # config
    debug=$(echo '${{ parameters.config }}' | jq -cr '.debug // empty')
    [ "$debug" = "" ] && debug="false"
    echo "##vso[task.setvariable variable=DEBUG;]$debug"
  
    stk=$(echo '${{ parameters.config }}' | jq -cr '.stk // empty')
    [ "$stk" = "" ] && stk="stk-beta"
    echo "##vso[task.setvariable variable=stk;]$stk"

    # cli_login
    email=$(echo '${{ parameters.api_inputs }}' | jq -cr '.cli_login_email // empty')
    echo "##vso[task.setvariable variable=email;]$email"
    echo "Parsed email: $email"

    realm=$(echo '${{ parameters.api_inputs }}' | jq -cr '.cli_login_realm // empty')
    echo "##vso[task.setvariable variable=realm;]$realm"
    echo "Parsed realm: $realm"

    # action

    workspace_slug=$(echo '${{ parameters.api_inputs }}' | jq -cr '.workspace_slug // empty')
    echo "##vso[task.setvariable variable=workspace_slug;]$workspace_slug"
    echo "Parsed realm: $workspace_slug"

    use_workspace_cmd=$(echo '${{ parameters.api_inputs }}' | jq -cr '.use_workspace_cmd // empty')
    echo "##vso[task.setvariable variable=use_workspace_cmd;]$use_workspace_cmd"
    echo "Parsed use_workspace_cmd: $use_workspace_cmd"

    run_action_cmd=$(echo '${{ parameters.api_inputs }}' | jq -cr '.run_action_cmd // empty')
    echo "##vso[task.setvariable variable=run_action_cmd;]$run_action_cmd"
    echo "Parsed run_action_cmd: $run_action_cmd"
  failOnStderr: true
  displayName: Validate inputs

- template: templates/install-stk-cli.yml

- template: templates/login-stk.yml

- bash: |
    echo "$(stk) $(use_workspace_cmd)"
    $(stk) $(use_workspace_cmd)
  displayName: Use workspace

- bash: |
    #colors
    u_cyan='\033[4;36m'
    green='\033[0;32m'

    echo -e "\n${green}âš¡ Running Action: ${u_cyan}$name"
    echo -e "$(stk) $(run_action_cmd) --non-interactive\n" 
    $(stk) $(run_action_cmd) --non-interactive
  displayName: Run action

- bash: |
    cat ~/.$(stk)/logs/*
  displayName: Show Error Log
  condition: failed()