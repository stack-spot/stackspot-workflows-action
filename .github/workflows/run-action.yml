name: Run Action
run-name: ${{ inputs.correlation_id }}
on: 
  workflow_dispatch:
    inputs:
      correlation_id:
        description: Correlation id
        required: true
      action:
        description: Action info (json)
        required: true
      secrets:
        description: Secrets info (json)
        required: true
      cli_login:
        description: CLI login info (json)
        required: true
      workspace_slug:
        description: Workspace identifier
        required: true

env:
  STK: stk-alpha #or 'stk-beta' or 'stk'
  DEBUG: true
jobs:

  validate-inputs:
    name: Validate JSON Inputs
    runs-on: [self-hosted, linux, stackspot-stacks-qa]
    steps:
      - name: Masking secrets inputs
        run: |
          SECRET_LOGIN_TOKEN=$(cat $GITHUB_EVENT_PATH | jq -r '.inputs.secrets' | jq -r '.cli_token' )
          echo "::add-mask::$SECRET_LOGIN_TOKEN"
          SECRET_LOGIN_TOKEN=$(cat $GITHUB_EVENT_PATH | jq -r '.inputs.secrets' )
          echo "::add-mask::$SECRET_LOGIN_TOKEN"
      - name: Debug inputs
        if: env.DEBUG
        run: |
          echo "action: ${{ github.event.inputs.action }}"
          echo "cli_login: ${{ github.event.inputs.cli_login }}"
          echo "workspace_slug: ${{ github.event.inputs.workspace_slug }}"
      - name: "Validate Input: 'action.name'"
        if: fromJson(github.event.inputs.action).name == ''
        run: |
         echo "ERROR: 'name' field not found in json for 'action' input"
         exit 1
      - name: "Validate Input: 'cli_login.email'"
        if: fromJson(github.event.inputs.cli_login).email == ''
        run: |
         echo "ERROR: 'email' field not found in json for 'cli_login' input"
         exit 1
      - name: "Validate Input: 'cli_login.realm'"
        if: fromJson(github.event.inputs.cli_login).realm == ''
        run: |
         echo "ERROR: 'realm' field not found in json for 'cli_login' input"
         exit 1
      - name: "Validate Input: 'secrets.cli_token'"
        if: fromJson(github.event.inputs.secrets).cli_token == ''
        run: |
         echo "ERROR: 'cli_token' field not found in json for 'secrets' input"
         exit 1

  run-action-using-stk-cli:
    name: Run Stackspot Action
    needs: validate-inputs
    env:
      INPUTS: '${{ inputs.action_inputs }}'
    runs-on: [self-hosted, linux, stackspot-stacks-qa]
    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@v3
      - name: Install STK
        uses: ./github-actions/install-stk-cli
        with: 
          stk: ${{ env.STK }}
      - name: Login STK
        uses: ./github-actions/login-stk
        with: 
          stk: ${{ env.STK }}
          email: ${{ fromJson(github.event.inputs.cli_login).email }}
          pat: ${{ fromJson(github.event.inputs.secrets).cli_token }}
          realm: ${{ fromJson(github.event.inputs.cli_login).realm }}
      - name: Use workspace
        run: |
         $STK use workspace ${{ inputs.workspace_slug }}
      - name: Run action
        env:
          NAME: ${{ fromJson(github.event.inputs.action).name }}
          INPUTS: ${{ toJson(fromJson(github.event.inputs.action).inputs) }}
          CI: ${{ toJson(fromJson(github.event.inputs.action).connectors) }}
          ACTION_ENV: ${{ fromJson(github.event.inputs.action).env }}
        run: |
          source .github/workflows/scripts/enable_colors.sh
          conn=""
          if [ "${CI}" != "null" ]; then 
              conn=" -ci $(echo $CI | jq . -c)"
          fi
          env=""
          if [ "${ACTION_ENV}" != "null" && "${ACTION_ENV}" != ""]; then
            env=" --env $ACTION_ENV"
          fi

          if [ "${INPUTS}" != "null" ]; then 
              inputs_short=" --inputs-json $(echo $INPUTS | jq . -c)"
              echo $inputs_short
          fi

          echo -e "\n${green}âš¡ Running Action: ${u_cyan}$NAME"
          echo -e "$STK run action $NAME $inputs_short $conn $env \n" 
          $STK run action $NAME $inputs_short $conn $env

      - name: Show Error Log
        if: failure()
        run: |
          cat ~/.$STK/logs/*