name: Run Action
run-name: ${{ inputs.correlation_id }}
on: 
  workflow_call:
    inputs:
      api_inputs:
        description: Action info (json)
        type: string
        required: true
      config:
        description: Workflow config (json)
        type: string
        required: true
    secrets:
      secrets:
        description: Secrets info (json)
        required: true
env:
  STK: ${{ fromJson(inputs.config).stk }}
  DEBUG: ${{ fromJson(inputs.config).debug }}
jobs:

  validate-inputs:
    name: Validate Inputs/Config
    runs-on: ${{ fromJson(inputs.config).runner }}
    steps:
      - name: Print inputs
        run: |
          echo "Inputs from api: ${{ inputs.api_inputs }}"

      - name: Print config
        run: |
          echo "Config: ${{ inputs.config }}"

      - name: "Validate config: 'config.stk'"
        if: fromJson(inputs.config).stk == ''
        run: |
         echo "ERROR: 'stk' field not found in json for 'config' input"
         exit 1

      - name: "Validate config: 'config.runner'"
        if: fromJson(inputs.config).runner == ''
        run: |
         echo "ERROR: 'runner' field not found in json for 'config' input"
         exit 1

  use-workspace:
    name: Prepare STK
    runs-on: ${{ fromJson(inputs.config).runner }}
    needs: validate-inputs
    env: 
      STK: ${{ fromJson(inputs.config).stk }}
    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@v3
        with:
          repository: ${{ fromJson(inputs.config).origin_repository }}
          ref: ${{ fromJson(inputs.config).origin_branch }}   
          token: ${{ fromJson(secrets.secrets).scm_token }}

      - name: Cache
        uses: ./github-actions/restore-stk-cache
        with: 
          stk: ${{ env.STK }}

      - name: Install STK
        uses: ./github-actions/install-stk-cli
        with: 
          stk: ${{ env.STK }}

      - name: Login ${{ fromJson(inputs.api_inputs).cli_login_email }}
        uses: ./github-actions/login-stk
        with: 
          stk: ${{ env.STK }}
          email: ${{ fromJson(inputs.api_inputs).cli_login_email }}
          pat: ${{ fromJson(secrets.secrets).cli_token }}
          realm: ${{ fromJson(inputs.api_inputs).cli_login_realm }}

      - name: Use workspace ${{ fromJson(inputs.api_inputs).workspace_slug }}
        run: |
          $STK use workspace ${{ fromJson(inputs.api_inputs).workspace_slug }}
      - name: Show Error Log
        if: failure()
        run: |
          cat ~/.$STK/logs/*

  run-action-using-stk-cli:
    name: Run Stackspot Action
    needs: use-workspace
    runs-on: ${{ fromJson(inputs.config).runner }}
    steps:
      - name: Checkout workflows repo
        uses: actions/checkout@v3
        with:
          repository: ${{ fromJson(inputs.config).origin_repository }}
          ref: ${{ fromJson(inputs.config).origin_branch }}

      - name: Restore STK Cache
        uses: ./workflow_repo/github-actions/restore-stk-cache 
        with: 
          stk: ${{ env.STK }}
      - name: Set git username
        run: |
          git config --global user.email "${{ fromJson(inputs.api_inputs).cli_login_email }}"
          git config --global user.name "${{ fromJson(inputs.api_inputs).cli_login_email }}"
      
      - name: Run action
        env:
          NAME: ${{ fromJson(inputs.api_inputs).action_name }}
          INPUTS: ${{ toJson(fromJson(inputs.api_inputs).action_inputs) }}
          CI: ${{ toJson(fromJson(inputs.api_inputs).action_connectors) }}
          ACTION_ENV: ${{ fromJson(inputs.api_inputs).action_env }}
        run: |
          source .github/workflows/scripts/enable_colors.sh
          conn=""
          if [ "${CI}" != "null" ]; then 
              conn=" --connection-interfaces $(echo $CI | jq . -c)"
          fi
          env=""

          if [ "${ACTION_ENV}" != "" ]; then
            env=" --env $ACTION_ENV"
          fi

          INPUTS=${{ inputs.api_inputs | js . -cr .plugin_inputs }}
          if [ "$INPUTS" != "" ]; then 
              inputs_short=" --inputs-json $(echo $INPUTS | jq . -c)"
              echo $inputs_short
          fi

          echo -e "\n${green}âš¡ Running Action: ${u_cyan}$NAME"
          echo -e "$STK run action $NAME $inputs_short $conn $env \n" 
          $STK run action $NAME $inputs_short $conn $env
      
      - name: Show Error Log
        if: failure()
        run: |
          cat ~/.$STK/logs/*